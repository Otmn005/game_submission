<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>UniLife Simulator ‚Äî RMIT City (Finalist Edition)</title>
<meta name="description" content="A BitLife-style wellbeing & study balance simulator for Australian uni students. Front-end only, offline playable." />
<style>
/* ==========================================================
   UniLife Simulator ‚Äî Finalist Edition
   Team: The Trinity ‚Ä¢ RMIT City Campus ‚Ä¢ 2025 Hackathon
   Single-file. Accessible. Mobile-friendly. Offline.
   ========================================================== */
:root{
  --bg1:#eaf7f4; --bg2:#eaf2fb; --panel:#ffffff; --ink:#0a2a2e; --muted:#46676d;
  --acc1:#2bb6f6; --acc2:#69e6b8; --stroke:#d8e5ec; --shadow:0 10px 30px rgba(9,30,66,.14);
  --good:#16a34a; --bad:#ef4444; --warn:#f59e0b; --barBG:#eef6fb;
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;color:var(--ink);font-family:Inter,system-ui,Segoe UI,Arial,sans-serif;
  background:linear-gradient(180deg,var(--bg1),var(--bg2));}
a{color:#0f6ea9} a:focus{outline:2px dashed #0f6ea9;outline-offset:2px}
.wrap{max-width:1120px;margin:0 auto;padding:18px}
header{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:12px}
h1{margin:0;font-size:26px}
.pill{font-size:12px;padding:4px 10px;border-radius:999px;border:1px solid var(--stroke);background:rgba(255,255,255,.9)}
.card{background:#fff;border:1px solid var(--stroke);border-radius:16px;box-shadow:var(--shadow)}
.panel{padding:18px}
.row{display:flex;gap:12px;flex-wrap:wrap}
.btn{border:1px solid var(--stroke);background:#f7fbff;color:var(--ink);padding:10px 14px;border-radius:12px;cursor:pointer}
.btn:hover,.btn:focus{border-color:var(--acc1);outline:none}
.btn.primary{background:linear-gradient(135deg,#8ee3ff,#b9fbd6);color:#05292f;border:none}
.btn.ghost{background:transparent}
.muted{color:var(--muted)}
footer{margin-top:12px;color:#5a7f85;font-size:12px;text-align:center}

.bg-stack{position:fixed;inset:0;z-index:-1}
.bg {position:absolute;inset:0;opacity:0;transition:opacity 1s ease}
.bg.show{opacity:.9}
.bg.library {background:radial-gradient(1200px 600px at 20% 10%, #fff 0%, #e8f2ff 40%, #dfe9ff 60%, #cfe0ff 100%)}
.bg.tram    {background:linear-gradient(120deg,#e4fff4,#e0f4ff 60%, #d1e3ff)}
.bg.dorm    {background:linear-gradient(180deg,#f7f0ff,#e8f6ff)}
.bg.roof    {background:radial-gradient(800px 500px at 70% 20%,#fff 0%,#fff8ec 30%,#ffeed0 50%,#ffe3aa)}
.bg.cafe    {background:linear-gradient(160deg,#fff4ea,#f0fff8)}

.hud{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.stat{background:#f7fbff;border:1px solid var(--stroke);padding:8px 10px;border-radius:12px;display:flex;gap:8px;align-items:center}
.bar{width:150px;height:10px;background:var(--barBG);border-radius:999px;overflow:hidden;border:1px solid var(--stroke)}
.bar>span{display:block;height:100%;background:linear-gradient(90deg,#8ee3ff,#b9fbd6);transition:width .25s ease}
.week-pill{padding:6px 10px;border-radius:10px;border:1px solid var(--stroke);background:#fff}
.legend,.objective,.settings{background:#f7fbff;border:1px solid var(--stroke);border-radius:12px;padding:8px 10px;font-size:13px}
.legend span{display:inline-block;margin-right:12px}
.objective b{color:#0f5132}
.log{height:260px;overflow:auto;background:#f7fbff;border:1px solid var(--stroke);border-radius:12px;padding:10px;font-size:14px;color:#335b60}
.log p{margin:6px 0}
.choices{display:grid;grid-template-columns:1fr;gap:10px}
.choice-btn{display:flex;justify-content:space-between;align-items:center}
.delta{font-size:12px;font-weight:600}
.pos{color:var(--good)} .neg{color:var(--bad)}
.tip{margin:10px 0 0}
.play-grid{display:grid;grid-template-columns:1.3fr .7fr;gap:14px}
@media (max-width:980px){.play-grid{grid-template-columns:1fr}}

.avatar{font-size:32px;line-height:1;filter:drop-shadow(0 4px 10px rgba(0,0,0,.08))}
.avatar-wrap{display:flex;align-items:center;gap:8px}

.modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:50}
.modal.show{display:flex}
.modal .box{max-width:720px;width:92%;background:#fff;border:1px solid var(--stroke);border-radius:16px;box-shadow:var(--shadow);padding:20px}
.center{text-align:center}

.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:20px;background:#ffffffee;border:1px solid var(--stroke);border-radius:12px;padding:10px 14px;box-shadow:var(--shadow);opacity:0;transition:opacity .4s, transform .4s;z-index:60}
.toast.show{opacity:1;transform:translate(-50%,0)}
.badge{position:fixed;right:16px;top:16px;background:#ffffffee;border:1px solid var(--stroke);border-radius:12px;padding:8px 12px;box-shadow:var(--shadow);opacity:0;transform:translateY(-8px);transition:opacity .4s, transform .4s;z-index:60}
.badge.show{opacity:1;transform:translateY(0)}
.egg{position:fixed;right:12px;top:60px;background:#ffffffee;border:1px solid var(--stroke);border-radius:12px;padding:8px 12px;font-size:13px;box-shadow:var(--shadow);opacity:0;transform:translateY(-8px);transition:opacity .4s, transform .4s;z-index:40}
.egg.show{opacity:1;transform:translateY(0)}

#confetti{position:fixed;inset:0;pointer-events:none;display:none;z-index:999}
#radar,#bar5{width:360px;height:360px;max-width:100%}
.breathe{width:120px;height:120px;border-radius:50%;margin:10px auto;background:radial-gradient(circle,#b9fbd6,#8ee3ff)}
.breathe.pulse{animation:breath 6s ease-in-out infinite}
@keyframes breath{0%{transform:scale(.9);opacity:.9}50%{transform:scale(1.04);opacity:1}100%{transform:scale(.9);opacity:.9}}
</style>
</head>
<body>
<!-- Backgrounds -->
<div class="bg-stack" aria-hidden="true">
  <div id="bgA" class="bg library show"></div>
  <div id="bgB" class="bg tram"></div>
</div>
<canvas id="confetti" aria-hidden="true"></canvas>

<div class="wrap">
  <header>
    <h1>UniLife Simulator ‚Äî RMIT City</h1>
    <div><span class="pill">Finalist Edition</span><span class="pill">Front‚Äëend only</span><span class="pill">Wellbeing Focus</span></div>
  </header>

  <!-- MENU -->
  <main id="view-menu" class="card panel" role="region" aria-label="Menu">
    <div class="row" style="align-items:flex-start">
      <section class="card panel" style="flex:1 1 520px">
        <h2 style="margin:0 0 6px">Start your semester</h2>
        <p class="muted">Balance <b>Wellbeing</b>, <b>Knowledge</b>, <b>Money</b>, and <b>Social</b> across 15 weeks. Aim to succeed <em>without</em> burning out.</p>
        <label>Display Name<br><input id="char-name" placeholder="e.g., Alex" aria-label="Display Name" style="width:100%;padding:10px;border-radius:10px;border:1px solid var(--stroke);margin:6px 0 10px"></label>
        <label>Major<br>
          <select id="char-major" aria-label="Major" style="width:100%;padding:10px;border-radius:10px;border:1px solid var(--stroke);margin:6px 0 10px">
            <option>General</option><option>Engineering</option><option>Health</option><option>Business</option>
          </select>
        </label>
        <label>Pronouns<br>
          <select id="char-pronouns" aria-label="Pronouns" style="width:100%;padding:10px;border-radius:10px;border:1px solid var(--stroke);margin:6px 0 10px">
            <option>they/them</option><option>she/her</option><option>he/him</option>
          </select>
        </label>
        <div class="legend" style="margin-top:6px">
          <label><input type="checkbox" id="toggle-ambience" checked> Ambient sound</label>
          <label style="margin-left:12px">Volume <input type="range" id="vol" min="0" max="1" step="0.02" value="0.32"></label>
          <label style="margin-left:12px"><input type="checkbox" id="toggle-mindful"> Mindful Mode (extra pauses & breathing)</label>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="btn primary" id="btn-start">Start Semester</button>
          <button class="btn" id="btn-continue">Continue Last Save</button>
        </div>
      </section>
      <aside class="card panel" style="flex:1 1 360px">
        <h3 style="margin:0 0 6px">How it works</h3>
        <ul class="muted">
          <li>Each turn = <b>1 week</b> (total 15)</li>
          <li>Each event offers <b>3‚Äì4 choices</b> with distinct impacts</li>
          <li>Stats: <b>WB</b>, <b>KN</b>, <b>$</b>, <b>SO</b></li>
          <li>Multiple endings are based on balance (not just grades)</li>
          <li><b>Keyboard:</b> 1‚Äì4 choose ‚Ä¢ <b>S</b> save ‚Ä¢ <b>Enter</b> first choice ‚Ä¢ <b>Esc</b> close</li>
        </ul>
        <button class="btn" id="btn-how">Tips</button>
      </aside>
    </div>
  </main>

  <!-- GAMEPLAY -->
  <section id="view-play" class="card panel" role="region" aria-label="Gameplay" style="display:none">
    <div class="play-grid">
      <div>
        <div class="hud" role="group" aria-label="HUD">
          <div class="week-pill">Week <span id="week-num">1</span>/15</div>
          <div class="stat" title="Wellbeing">WB <div class="bar"><span id="wb-bar"></span></div><span id="wb-num">70</span></div>
          <div class="stat" title="Knowledge">KN <div class="bar"><span id="kn-bar"></span></div><span id="kn-num">40</span></div>
          <div class="stat" title="Money">$ <div class="bar"><span id="mo-bar"></span></div><span id="mo-num">50</span></div>
          <div class="stat" title="Social">SO <div class="bar"><span id="so-bar"></span></div><span id="so-num">40</span></div>
          <div class="avatar-wrap"><span class="muted">Mood:</span> <span id="avatar" class="avatar" aria-label="Avatar">üôÇ</span></div>
          <button class="btn" id="btn-save">üíæ Save</button>
          <button class="btn ghost" id="btn-end">End Early</button>
        </div>

        <div class="legend" style="margin-top:10px"><b>Legend:</b>
          <span>WB = Wellbeing</span><span>KN = Knowledge</span><span>$ = Money</span><span>SO = Social</span>
        </div>

        <div id="event-card" class="card panel" style="background:#f7fbff;margin-top:12px">
          <h3 id="ev-title" style="margin:0 0 6px">Welcome to Week 1</h3>
          <p id="ev-text" class="muted" style="margin-top:0">Make a choice to set your rhythm.</p>
          <div class="choices" id="ev-choices" role="group" aria-label="Choices"></div>
          <p id="ev-tip" class="muted tip" aria-live="polite"></p>
        </div>

        <div class="objective" style="margin-top:12px" aria-label="Objective">
          üéØ <b>Objective:</b> Maintain balance. Aim for <b>Wellbeing ‚â• 60</b> by Week 15 while building Knowledge to pass.
        </div>
      </div>

      <aside class="card panel" aria-label="Action Log">
        <h3 style="margin-top:0">Log</h3>
        <div id="log" class="log" aria-live="polite"></div>
        <div class="legend" style="margin-top:10px"><b>Trivia</b>: <span id="trivia">‚Äî</span></div>
      </aside>
    </div>
  </section>

  <!-- RESULTS -->
  <section id="view-results" class="card panel" role="region" aria-label="Results" style="display:none">
    <h2 id="result-title" style="margin-top:0">Semester Summary</h2>
    <p id="result-body" class="muted"></p>

    <div class="row" style="align-items:center">
      <canvas id="radar" width="360" height="360" aria-label="Stats radar chart"></canvas>
      <div class="card panel" style="background:#f7fbff;flex:1 1 320px">
        <h3 style="margin:0 0 6px">Personal Insights</h3>
        <p id="insight" class="muted">‚Äî</p>
        <div class="legend" style="margin-top:10px"><b>Achievements:</b> <span id="badge-list">None yet</span></div>

        <h3 style="margin:12px 0 6px">Helpful resources (Australia)</h3>
        <ul style="margin:0 0 6px 18px">
          <li><a href="https://www.lifeline.org.au/" target="_blank" rel="noopener">Lifeline ‚Äî 13 11 14</a></li>
          <li><a href="https://www.beyondblue.org.au/" target="_blank" rel="noopener">Beyond Blue ‚Äî 1300 22 4636</a></li>
          <li><a href="https://www.rmit.edu.au/students/support-and-facilities/student-support/counselling" target="_blank" rel="noopener">RMIT Counselling & Wellbeing</a></li>
        </ul>
        <p class="muted" style="margin:6px 0 0">If it‚Äôs an emergency, call <b>000</b>.</p>
      </div>
    </div>

    <div class="legend" style="margin-top:10px">
      <b>Final Stats:</b>
      <span id="final-wb"></span> WB ‚Ä¢ <span id="final-kn"></span> KN ‚Ä¢ <span id="final-mo"></span> $ ‚Ä¢ <span id="final-so"></span> SO
    </div>

    <div class="row" style="align-items:center;margin-top:10px">
      <button class="btn" id="btn-download">üìÑ Download Journey</button>
      <div class="legend" id="leaderboard" style="flex:1 1 auto">‚Äî</div>
    </div>

    <div class="center" style="margin-top:10px">
      <div class="breathe pulse" aria-hidden="true"></div>
    </div>

    <div class="hud" style="margin-top:10px">
      <button class="btn primary" id="btn-restart">Play Again</button>
      <button class="btn ghost" id="btn-menu">Back to Menu</button>
    </div>
  </section>

  <footer>¬© 2025 The Trinity ‚Äî RMIT City Campus ‚Ä¢ Front‚Äëend only</footer>
</div>

<!-- Modals -->
<div id="modal-reflect" class="modal" role="dialog" aria-modal="true" aria-labelledby="reflect-title" data-esc>
  <div class="box">
    <h3 id="reflect-title">Mid‚ÄëSemester Check‚ÄëIn</h3>
    <p id="reflect-body" class="muted"></p>
    <div class="center"><button class="btn primary" id="reflect-continue">Continue</button></div>
  </div>
</div>

<div id="modal-feel" class="modal" role="dialog" aria-modal="true" aria-labelledby="feel-title" data-esc>
  <div class="box">
    <h3 id="feel-title">The semester is ending. How do you feel right now?</h3>
    <div class="row" style="justify-content:center">
      <button class="btn" data-feel="Grateful">Grateful üå§Ô∏è</button>
      <button class="btn" data-feel="Tired">Tired üòÆ‚Äçüí®</button>
      <button class="btn" data-feel="Balanced">Balanced üéØ</button>
      <button class="btn" data-feel="Motivated">Motivated üí™</button>
    </div>
  </div>
</div>

<div id="modal-journal" class="modal" role="dialog" aria-modal="true" aria-labelledby="journal-title" data-esc>
  <div class="box">
    <h3 id="journal-title">Final Reflection</h3>
    <p class="muted">Choose one sentence that best summarises your term‚Äôs lesson:</p>
    <div class="row" style="justify-content:center">
      <button class="btn" data-j="Small daily recovery beats last-minute rescue.">Small daily recovery beats last-minute rescue.</button>
      <button class="btn" data-j="Balance isn‚Äôt perfection ‚Äî it‚Äôs pacing and support.">Balance isn‚Äôt perfection ‚Äî it‚Äôs pacing and support.</button>
      <button class="btn" data-j="Connection fuels learning more than isolation.">Connection fuels learning more than isolation.</button>
      <button class="btn" data-j="Boundaries at work protect my study and sleep.">Boundaries at work protect my study and sleep.</button>
    </div>
  </div>
</div>

<div id="modal-trivia" class="modal" role="dialog" aria-modal="true" aria-labelledby="trivia-title" data-esc>
  <div class="box">
    <h3 id="trivia-title">Did you know?</h3>
    <p id="trivia-body" class="muted"></p>
    <div class="center"><button class="btn" id="trivia-ok">Got it</button></div>
  </div>
</div>

<div id="modal-5w" class="modal" role="dialog" aria-modal="true" aria-labelledby="w5-title" data-esc>
  <div class="box">
    <h3 id="w5-title">5‚ÄëWeek Reflection</h3>
    <canvas id="bar5" width="420" height="320" aria-label="Last 5 weeks chart"></canvas>
    <p id="w5-msg" class="muted center"></p>
    <div class="center"><button class="btn primary" id="w5-continue">Continue</button></div>
  </div>
</div>

<!-- Floating UI elements -->
<div id="toast" class="toast" role="status" aria-live="polite"></div>
<div id="badge" class="badge" aria-live="polite"></div>
<div id="egg" class="egg" aria-live="polite"></div>

<script>
/* ================== UTIL & STATE ================== */
const $ = s => document.querySelector(s);
const rnd = a => a[(Math.random()*a.length)|0];
const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
const MAX_WEEKS=15, SAVE_KEY='unilife_save', HISTORY_KEY='unilife_history';
let mindfulMode=false;

const state = {
  name:'Alex', major:'General', pronouns:'they/them',
  week:1, wb:70, kn:40, mo:50, so:40,
  finished:false, journal:'', feelings:'', log:[],
  eventHistory:[], lastEventIdx:-1,
  deltaHistory:[]
};

/* ================== AUDIO ================== */
const AudioSys = (()=>{
  const Ctx = window.AudioContext||window.webkitAudioContext;
  const ctx = Ctx? new Ctx(): null;
  let vol=null; let ambienceOn=true;
  function setup(){ if(!ctx) return; vol=ctx.createGain(); vol.gain.value=document.getElementById('vol').value; vol.connect(ctx.destination); }
  function setVolume(v){ if(vol) vol.gain.value=v; }
  function toggle(on){ ambienceOn=on; if(!on) stopAll(); else updateAmbience(); }
  function beep({freq=440,dur=0.1,type='sine',volm=0.03}){ if(!ctx) return; const o=ctx.createOscillator(), g=ctx.createGain(); o.type=type;o.frequency.value=freq; g.gain.value=volm; o.connect(g).connect(ctx.destination); o.start(); g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+dur); o.stop(ctx.currentTime+dur+0.02); }
  const click=()=>beep({freq:600,dur:.08,type:'sine',volm:.04});
  const good =()=>beep({freq:740,dur:.12,type:'triangle',volm:.04});
  const bad  =()=>beep({freq:300,dur:.16,type:'sawtooth',volm:.035});
  let loop=null;
  function stopAll(){ if(loop){ try{loop.stop()}catch{} loop.disconnect(); loop=null; } }
  function startTone(freq,gain){ if(!ctx) return; stopAll(); const o=ctx.createOscillator(), g=ctx.createGain(); g.gain.value=gain; o.type='sine'; o.frequency.value=freq; o.connect(g).connect(vol||ctx.destination); o.start(); loop=o; }
  function updateAmbience(){ if(!ctx||!ambienceOn) return; if(state.wb>=70){ startTone(180,.02); } else if(state.wb<40){ startTone(120,.03); } else { startTone(200,.02); } }
  return {ctx,setup,setVolume,toggle,click,good,bad,updateAmbience};
})();
// user gesture resume
['click','keydown','touchstart'].forEach(ev=>document.addEventListener(ev,()=>{ if(AudioSys.ctx && AudioSys.ctx.state==='suspended'){ AudioSys.ctx.resume(); } },{once:true,passive:true}));

/* ================== CONFETTI ================== */
const Confetti = (()=>{
  const c=document.getElementById('confetti'), x=c.getContext('2d'); let parts=[], running=false, raf=null;
  function resize(){ c.width=innerWidth; c.height=innerHeight; } addEventListener('resize',resize); resize();
  function burst(n=160){ parts=[]; for(let i=0;i<n;i++) parts.push({x:innerWidth/2,y:innerHeight/3,vx:(Math.random()-.5)*6,vy:(Math.random()-.8)*6-2,g:.12+Math.random()*.1,s:4+Math.random()*4,a:1,c:`hsl(${Math.random()*360},80%,70%)`,rot:Math.random()*6.28,vr:(Math.random()-.5)*.2}); c.style.display='block'; running=true; loop(); setTimeout(()=>{running=false;c.style.display='none'},2600) }
  function loop(){ if(!running){ cancelAnimationFrame(raf); return } raf=requestAnimationFrame(loop); x.clearRect(0,0,c.width,c.height); parts.forEach(p=>{p.vy+=p.g;p.x+=p.vx;p.y+=p.vy;p.rot+=p.vr;p.a*=.996;x.save();x.globalAlpha=p.a;x.translate(p.x,p.y);x.rotate(p.rot);x.fillStyle=p.c;x.fillRect(-p.s/2,-p.s/2,p.s,p.s);x.restore()}) }
  return {burst};
})();

/* ================== BACKGROUNDS & EASTER EGGS ================== */
const BG_CLASSES=['library','tram','dorm','roof','cafe']; let bgToggle=false;
const EASTER = [
  "üìç You overhear students debating AI ethics outside Building 80.",
  "üìç The tram passes Swanston Street as sunlight hits the RMIT logo.",
  "üìç You find a quiet corner in the RMIT Library ‚Äî peace at last.",
  "üìç A poster about wellbeing workshops catches your eye near Bowen St.",
  "üìç A tutor mentions study skills sessions at Building 8."
];
function setBackground(){
  const next = rnd(BG_CLASSES);
  const A=document.getElementById('bgA'), B=document.getElementById('bgB');
  if(!bgToggle){ A.className='bg '+next+' show'; B.className='bg '+rnd(BG_CLASSES); }
  else { B.className='bg '+next+' show'; A.className='bg '+rnd(BG_CLASSES); }
  bgToggle=!bgToggle;
  if(Math.random()<0.10){ const e=document.getElementById('egg'); e.textContent=rnd(EASTER); e.classList.add('show'); setTimeout(()=>e.classList.remove('show'), 3500); }
}

/* ================== TRIVIA ================== */
const TRIVIA = [
 "7‚Äì9 hours of sleep improves memory consolidation.",
 "Brief daylight supports circadian rhythm and mood.",
 "Social connection protects student mental health.",
 "Hydration can improve attention and reduce fatigue.",
 "Short movement breaks help sustain focus.",
 "Early support (counselling/GP plan) reduces escalation risk.",
 "Planning with breaks beats cramming for retention."
];

/* ================== EVENTS ================== */
// Each with a tag to support Dynamic Difficulty
const EVENTS = [
 {title:"Week start routine", tag:'selfcare', text:"How do you set your rhythm this week?",
  options:[
    {label:"Plan Pomodoro + breaks", delta:{wb:+4, kn:+4, mo:0, so:+1}, tip:"Intervals support focus & recovery."},
    {label:"Grind long sessions",   delta:{wb:-6, kn:+6, mo:0, so:-1}, tip:"Overwork harms sleep & mood."},
    {label:"Light start + coffee with a mate", delta:{wb:+3, kn:+1, mo:-2, so:+4}, tip:"Connection boosts motivation."}
  ]},
 {title:"Heatwave alert", tag:'selfcare', text:"It‚Äôs 36‚Äì38¬∞C with high UV in Melbourne.",
  options:[
    {label:"Study early indoors + hydrate", delta:{wb:+4, kn:+2, mo:0, so:0}, tip:"Heat & dehydration impair cognition."},
    {label:"Outdoor cram", delta:{wb:-6, kn:+2, mo:0, so:0}, tip:"High heat worsens fatigue."},
    {label:"Short gym session", delta:{wb:+3, kn:+1, mo:-1, so:+1}, tip:"Light exercise stabilises mood."}
  ]},
 {title:"Group assignment", tag:'study', text:"Team proposes splitting tasks and milestones.",
  options:[
    {label:"Define roles & deadlines", delta:{wb:+3, kn:+5, mo:0, so:+2}, tip:"Clarity lowers stress."},
    {label:"Let it evolve organically", delta:{wb:-4, kn:+1, mo:0, so:-1}, tip:"Chaos ‚Üí crunch later."},
    {label:"Volunteer for heavy part", delta:{wb:-3, kn:+6, mo:0, so:+1}, tip:"Growth, but mind the load."}
  ]},
 {title:"Part-time shift offer", tag:'budget', text:"Manager asks for an extra evening shift.",
  options:[
    {label:"Negotiate different slot", delta:{wb:+2, kn:+2, mo:+2, so:0}, tip:"Boundaries protect sleep & study."},
    {label:"Accept & cut sleep", delta:{wb:-7, kn:+2, mo:+5, so:0}, tip:"Sleep loss tanks mood."},
    {label:"Decline this week", delta:{wb:+1, kn:+1, mo:0, so:-1}, tip:"Short-term no, long-term wellbeing."}
  ]},
 {title:"Counselling drop-in", tag:'selfcare', text:"Free short consults available this week.",
  options:[
    {label:"Attend 20‚Äëmin session", delta:{wb:+8, kn:0, mo:0, so:+1}, tip:"Early support prevents escalation."},
    {label:"Read self-help page", delta:{wb:+3, kn:+1, mo:0, so:0}, tip:"Psychoeducation helps too."},
    {label:"Skip ‚Äî no time", delta:{wb:-3, kn:+1, mo:0, so:0}, tip:"Avoidance often backfires."}
  ]},
 {title:"Myki fares & budget", tag:'budget', text:"Transport costs are tight this month.",
  options:[
    {label:"Batch on‚Äëcampus days", delta:{wb:+2, kn:+2, mo:+3, so:0}, tip:"Fewer trips = lower stress & cost."},
    {label:"Travel daily as usual", delta:{wb:0, kn:+1, mo:-3, so:+1}, tip:"Routine ok, but costs add up."},
    {label:"Study from home", delta:{wb:+1, kn:+1, mo:+2, so:-2}, tip:"Remote helps, less social."}
  ]},
 {title:"Exam prep", tag:'study', text:"Two finals are approaching.",
  options:[
    {label:"Timetable + breaks", delta:{wb:+3, kn:+6, mo:0, so:0}, tip:"Structure beats panic."},
    {label:"All‚Äënighter blitz", delta:{wb:-10,kn:+6, mo:0, so:-1}, tip:"Crash risk next week."},
    {label:"Peer study circle", delta:{wb:+3, kn:+5, mo:0, so:+3}, tip:"Belonging lifts motivation."}
  ]},
 {title:"Sleep hygiene", tag:'selfcare', text:"It‚Äôs late. Caffeine is tempting.",
  options:[
    {label:"Wind‚Äëdown + water", delta:{wb:+4, kn:+1, mo:0, so:0}, tip:"Sleep quality compounds."},
    {label:"Late coffee & scroll", delta:{wb:-5, kn:0, mo:0, so:-1}, tip:"Stimulants disrupt sleep."},
    {label:"Tea + journaling", delta:{wb:+3, kn:+1, mo:0, so:0}, tip:"Reflection regulates stress."}
  ]},
 {title:"Inclusion event", tag:'social', text:"Cultural society invites you to an evening gathering.",
  options:[
    {label:"Attend & connect", delta:{wb:+4, kn:+1, mo:-2, so:+5}, tip:"Belonging protects mental health."},
    {label:"Drop by briefly", delta:{wb:+2, kn:+1, mo:-1, so:+2}, tip:"Micro‚Äësocial boosts morale."},
    {label:"Skip to study", delta:{wb:-1, kn:+3, mo:0, so:-2}, tip:"Over‚Äëisolation risks burnout."}
  ]},
 {title:"Rent pressure", tag:'budget', text:"Your rent increases mid‚Äësemester.",
  options:[
    {label:"Budget & seek advice", delta:{wb:+1, kn:+1, mo:+4, so:0}, tip:"Student services can help."},
    {label:"Cut social for savings", delta:{wb:-2, kn:+1, mo:+5, so:-4}, tip:"Balance cost & connection."},
    {label:"Ignore for now", delta:{wb:-5, kn:0, mo:-3, so:0}, tip:"Uncertainty magnifies stress."}
  ]},
 {title:"Digital overload", tag:'selfcare', text:"Screen time hit 5+ hours/day.",
  options:[
    {label:"App timers + focus mode", delta:{wb:+3, kn:+2, mo:0, so:0}, tip:"Boundaries restore attention."},
    {label:"No change", delta:{wb:-3, kn:0, mo:0, so:0}, tip:"Doomscroll drains mood."},
    {label:"Reading group", delta:{wb:+2, kn:+3, mo:0, so:+2}, tip:"Analog focus + community."}
  ]},
 {title:"Library workshop", tag:'study', text:"Referencing & research workshop on campus.",
  options:[
    {label:"Attend session", delta:{wb:+1, kn:+5, mo:0, so:+1}, tip:"Skills reduce future stress."},
    {label:"Browse slides later", delta:{wb:+1, kn:+2, mo:0, so:0}, tip:"Better than skipping."},
    {label:"Skip", delta:{wb:0, kn:0, mo:0, so:0}, tip:"Missed opportunity."}
  ]},
 {title:"Healthy snack", tag:'selfcare', text:"You‚Äôve got 20 minutes between lectures.",
  options:[
    {label:"Fruit + water", delta:{wb:+2, kn:+1, mo:-1, so:0}, tip:"Steady energy > sugar spikes."},
    {label:"Energy drink", delta:{wb:-1, kn:+1, mo:-2, so:0}, tip:"Crash likely later."},
    {label:"Walk with a mate", delta:{wb:+2, kn:+1, mo:0, so:+3}, tip:"Movement + connection help mood."}
  ]},
 {title:"Commute delay", tag:'selfcare', text:"Signal fault on the line, you‚Äôre stuck.",
  options:[
    {label:"Plan tasks & revise", delta:{wb:+1, kn:+2, mo:0, so:0}, tip:"Reframe dead time."},
    {label:"Mindfulness break", delta:{wb:+2, kn:+1, mo:0, so:0}, tip:"Brief resets aid focus."},
    {label:"Panic & scroll", delta:{wb:-3, kn:0, mo:0, so:0}, tip:"Anxiety drains energy."}
  ]},
 {title:"Peer check‚Äëin", tag:'social', text:"A friend asks how you‚Äôre coping.",
  options:[
    {label:"Open up & plan week", delta:{wb:+5, kn:+1, mo:0, so:+3}, tip:"Social support is protective."},
    {label:"Short chat", delta:{wb:+2, kn:+1, mo:0, so:+2}, tip:"Even brief contact helps."},
    {label:"Ghost them", delta:{wb:-3, kn:0, mo:0, so:-3}, tip:"Isolation raises risk."}
  ]},
 {title:"Clinic visit", tag:'selfcare', text:"GP bookings for Mental Health Plans (Medicare rebates).",
  options:[
    {label:"Book GP this week", delta:{wb:+9, kn:0, mo:-1, so:+1}, tip:"Early care, lower cost."},
    {label:"Read about options", delta:{wb:+3, kn:+1, mo:0, so:0}, tip:"Inform first ‚Äî then act."},
    {label:"Delay another month", delta:{wb:-2, kn:0, mo:0, so:0}, tip:"Delays add stress."}
  ]}
];

/* ================== HELPERS ================== */
const wbBar = () => document.getElementById('wb-bar'),
      knBar= () => document.getElementById('kn-bar'),
      moBar= () => document.getElementById('mo-bar'),
      soBar= () => document.getElementById('so-bar');
const logEl = document.getElementById('log');
const fmt = v => (v>=0?'+':'')+v;
const colorSpan = v => `<span class="${v>=0?'pos':'neg'}">${fmt(v)}</span>`;

function updateHUD(){
  document.getElementById('week-num').textContent=state.week;
  document.getElementById('wb-num').textContent=clamp(state.wb,0,100);
  document.getElementById('kn-num').textContent=clamp(state.kn,0,100);
  document.getElementById('mo-num').textContent=clamp(state.mo,0,100);
  document.getElementById('so-num').textContent=clamp(state.so,0,100);
  wbBar().style.width=clamp(state.wb,0,100)+'%';
  knBar().style.width=clamp(state.kn,0,100)+'%';
  moBar().style.width=clamp(state.mo,0,100)+'%';
  soBar().style.width=clamp(state.so,0,100)+'%';
  const a=document.getElementById('avatar'); a.textContent = state.wb>=70?'üòÑ': state.wb>=40?'üôÇ': state.wb>=20?'üòì':'ü•µ';
  AudioSys.updateAmbience();
}
function show(view){
  document.getElementById('view-menu').style.display   = view==='menu'?'block':'none';
  document.getElementById('view-play').style.display   = view==='play'?'block':'none';
  document.getElementById('view-results').style.display= view==='results'?'block':'none';
}
function log(html){ const p=document.createElement('p'); p.innerHTML=html; logEl.prepend(p); }
function showToast(text){ const t=document.getElementById('toast'); t.textContent=text; t.classList.add('show'); AudioSys.beep?AudioSys.beep({freq:680,type:'triangle',dur:.12,volm:.03}):null; setTimeout(()=>t.classList.remove('show'), 2400); }
function showBadge(text){ const b=document.getElementById('badge'); b.innerHTML=text; b.classList.add('show'); setTimeout(()=>b.classList.remove('show'), 2000); }

/* ================== EVENT PICK + DDA ================== */
function pickEventIndex(){
  const used = new Set(state.eventHistory);
  let candidates = EVENTS.map((_,i)=>i).filter(i=>!used.has(i));
  if(candidates.length===0){ state.eventHistory=[]; candidates = EVENTS.map((_,i)=>i); }
  candidates = candidates.filter(i=>i!==state.lastEventIdx);
  if(candidates.length===0) candidates = EVENTS.map((_,i)=>i).filter(i=>i!==state.lastEventIdx);

  const weights = candidates.map(i=>{
    const t = EVENTS[i].tag; let w=1;
    if(state.wb<30 && t==='selfcare') w+=2.5;
    if(state.kn<40 && t==='study')    w+=2.0;
    if(state.mo<25 && t==='budget')   w+=2.0;
    if(state.so<30 && t==='social')   w+=2.0;
    return w;
  });
  const sum = weights.reduce((a,b)=>a+b,0); let r = Math.random()*sum;
  for(let idx=0; idx<candidates.length; idx++){ if((r-=weights[idx])<=0) return candidates[idx]; }
  return candidates[0];
}

let currentEventIdx=-1;
function renderEventByIndex(i){
  currentEventIdx=i;
  const ev = EVENTS[i];
  document.getElementById('ev-title').textContent=ev.title;
  document.getElementById('ev-text').textContent=ev.text;
  const box=document.getElementById('ev-choices'); box.innerHTML='';
  ev.options.forEach((opt,ix)=>{
    const b=document.createElement('button');
    b.className='btn choice-btn';
    b.setAttribute('aria-label',`Choice ${ix+1}: ${opt.label}`);
    b.innerHTML=`<span>${String.fromCharCode(65+ix)}) ${opt.label}</span>
      <span class="delta">WB ${colorSpan(opt.delta.wb||0)} ‚Ä¢ KN ${colorSpan(opt.delta.kn||0)} ‚Ä¢ $ ${colorSpan(opt.delta.mo||0)} ‚Ä¢ SO ${colorSpan(opt.delta.so||0)}</span>`;
    b.addEventListener('click', ()=>{
      Array.from(document.querySelectorAll('#ev-choices .btn')).forEach(btn=>btn.disabled=true);
      applyChoice(opt);
      setTimeout(()=>Array.from(document.querySelectorAll('#ev-choices .btn')).forEach(btn=>btn.disabled=false),380);
    });
    box.appendChild(b);
  });
  document.getElementById('ev-tip').textContent='';
  document.getElementById('trivia').textContent = rnd(TRIVIA);
  setBackground();
}

/* ================== APPLY CHOICE / ADVANCE ================== */
function applyChoice(opt){
  const d = { wb:opt.delta.wb||0, kn:opt.delta.kn||0, mo:opt.delta.mo||0, so:opt.delta.so||0 };
  state.wb=clamp(state.wb+d.wb,0,100);
  state.kn=clamp(state.kn+d.kn,0,100);
  state.mo=clamp(state.mo+d.mo,0,100);
  state.so=clamp(state.so+d.so,0,100);
  updateHUD();
  log(`${opt.label} ‚Üí WB ${colorSpan(d.wb)} ‚Ä¢ KN ${colorSpan(d.kn)} ‚Ä¢ $ ${colorSpan(d.mo)} ‚Ä¢ SO ${colorSpan(d.so)}`);
  document.getElementById('ev-tip').textContent='Tip: '+(opt.tip||'');
  const sum=d.wb+d.kn+d.mo+d.so; if(sum>=0) AudioSys.good(); else AudioSys.bad();
  state.deltaHistory.push(d);

  const toastBank = [
    "You feel calmer after setting boundaries.",
    "Your social battery feels recharged.",
    "It feels good to make steady progress.",
    "Tiny wins stack up over time.",
    "A short break was worth it."
  ];
  showToast(rnd(toastBank));
  if(d.wb>=+5) showBadge("üßò Calm Restored");
  if(d.kn>=+5) showBadge("üí° Insight Gained");
  if(d.so>=+4) showBadge("ü§ù Connected");
  if(d.mo>=+4) showBadge("üí∏ Budget Boost");

  if(state.week % 5 === 0 && state.week < 15){
    open5WReflection(); return;
  }
  if(state.week===14){ openFeelings(); return; }

  advanceWeekOrEnd();
  saveLocal();
}

function advanceWeekOrEnd(){
  if(currentEventIdx!==-1 && !state.eventHistory.includes(currentEventIdx)){
    state.eventHistory.push(currentEventIdx);
    state.lastEventIdx = currentEventIdx;
  }
  if(state.week >= MAX_WEEKS){ openJournal(); return; }
  state.week += 1;
  updateHUD();
  renderEventByIndex(pickEventIndex());
  saveLocal();
}

/* ================== MODALS ================== */
function openReflection(){
  const modal=document.getElementById('modal-reflect');
  const strong = strongestStat(), weak = weakestStat();
  const lines = { wb:"You‚Äôve cared for your energy even when deadlines loomed.", kn:"You‚Äôve pushed your learning steadily ‚Äî nice pacing.", mo:"You‚Äôve kept a careful eye on costs under pressure.", so:"You‚Äôve made time for people who lift you up." };
  const concerns = { wb:"But rest has been thin ‚Äî small daily resets could help.", kn:"But learning felt frantic ‚Äî structure beats panic.", mo:"Money stress is heavy ‚Äî batching trips or budgeting may ease it.", so:"Connection dipped ‚Äî even one weekly catch-up protects wellbeing." };
  document.getElementById('reflect-title').textContent = state.week===7? "Mid‚ÄëSemester Check‚ÄëIn":"Second Wind Check‚ÄëIn";
  document.getElementById('reflect-body').textContent = `So far, your strength is ${labelOf(strong)}. ${lines[strong]} Your lowest area is ${labelOf(weak)}. ${concerns[weak]}`;
  modal.classList.add('show');
  document.getElementById('reflect-continue').onclick = ()=> modal.classList.remove('show');
}
function openFeelings(){
  const modal=document.getElementById('modal-feel'); modal.classList.add('show');
  modal.querySelectorAll('button[data-feel]').forEach(btn=>{
    btn.onclick=()=>{
      const val=btn.getAttribute('data-feel'); state.feelings=val;
      if(val==='Grateful'){ state.wb=clamp(state.wb+2,0,100); }
      if(val==='Tired'){ state.wb=clamp(state.wb-2,0,100); }
      if(val==='Balanced'){ state.so=clamp(state.so+1,0,100); state.kn=clamp(state.kn+1,0,100); }
      if(val==='Motivated'){ state.kn=clamp(state.kn+2,0,100); }
      updateHUD();
      modal.classList.remove('show');
      advanceWeekOrEnd();
    };
  });
}
function openJournal(){
  const modal=document.getElementById('modal-journal'); modal.classList.add('show');
  modal.querySelectorAll('button[data-j]').forEach(btn=>{
    btn.onclick=()=>{ state.journal=btn.getAttribute('data-j'); modal.classList.remove('show'); endGame(); };
  });
}
function open5WReflection(){
  const modal=document.getElementById('modal-5w');
  const slice = state.deltaHistory.slice(-5);
  const sums = slice.reduce((a,d)=>({wb:a.wb+d.wb,kn:a.kn+d.kn,mo:a.mo+d.mo,so:a.so+d.so}),{wb:0,kn:0,mo:0,so:0});
  const avg = { wb:slice.length?Math.round(sums.wb/slice.length):0, kn:slice.length?Math.round(sums.kn/slice.length):0, mo:slice.length?Math.round(sums.mo/slice.length):0, so:slice.length?Math.round(sums.so/slice.length):0 };
  drawBars(avg);
  const msg = avg.kn>avg.wb? "You‚Äôve made steady growth in Knowledge but seem more drained ‚Äî remember to rest." : "Nice balance emerging ‚Äî keep small recovery habits.";
  document.getElementById('w5-msg').textContent = msg;
  modal.classList.add('show');
  document.getElementById('w5-continue').onclick = () => {
    modal.classList.remove('show');
    if (state.week < MAX_WEEKS) {
      state.week += 1;
      updateHUD();
      renderEventByIndex(pickEventIndex());
      saveLocal();
    } else {
      openJournal();
    }
  };
}

/* ================== CHARTS ================== */
function drawRadar(wb,kn,mo,so){
  const c=document.getElementById('radar'),x=c.getContext('2d'); const W=c.width,H=c.height,cx=W/2,cy=H/2,r=Math.min(W,H)/2-30;
  x.clearRect(0,0,W,H); x.strokeStyle='#dbe7ee'; x.lineWidth=1;
  for(let i=1;i<=3;i++){ x.beginPath(); x.arc(cx,cy,(r*i)/3,0,Math.PI*2); x.stroke(); }
  const labels=['Wellbeing','Knowledge','Money','Social'];
  x.fillStyle='#486e73'; x.font='12px system-ui';
  for(let i=0;i<4;i++){ const a=(-Math.PI/2)+(i*Math.PI/2),ex=cx+Math.cos(a)*r,ey=cy+Math.sin(a)*r;
    x.beginPath(); x.moveTo(cx,cy); x.lineTo(ex,ey); x.stroke();
    const lx=cx+Math.cos(a)*(r+12), ly=cy+Math.sin(a)*(r+12);
    x.textAlign='center'; x.textBaseline='middle'; x.fillText(labels[i],lx,ly); }
  const vals=[wb,kn,mo,so].map(v=>clamp(v,0,100));
  x.beginPath(); for(let i=0;i<4;i++){ const a=(-Math.PI/2)+(i*Math.PI/2), pr=r*(vals[i]/100); const px=cx+Math.cos(a)*pr, py=cy+Math.sin(a)*pr; i?x.lineTo(px,py):x.moveTo(px,py); } x.closePath();
  const g=x.createLinearGradient(0,0,W,H); g.addColorStop(0,'#8ee3ff88'); g.addColorStop(1,'#b9fbd688'); x.fillStyle=g; x.fill(); x.strokeStyle='#2bb6f6'; x.lineWidth=2; x.stroke();
}
function drawBars(avg){
  const c=document.getElementById('bar5'), x=c.getContext('2d'); x.clearRect(0,0,c.width,c.height);
  const keys=['WB','KN','$','SO']; const vals=[avg.wb,avg.kn,avg.mo,avg.so];
  const max= Math.max(10, ...vals.map(v=>Math.abs(v))); const w=60, gap=40, base=240;
  x.font='12px system-ui'; x.textAlign='center';
  keys.forEach((k,i)=>{
    const v=vals[i]; const h=(v/max)*120; const cx=60+i*(w+gap);
    x.fillStyle='#dfeffc'; x.fillRect(cx, base-120, w, 120);
    x.fillStyle= v>=0 ? '#16a34a' : '#ef4444';
    x.fillRect(cx, base - (v>=0?h:0), w, Math.abs(h));
    x.fillStyle='#486e73'; x.fillText(k, cx+w/2, base+16); x.fillText((v>=0?'+':'')+v, cx+w/2, base-130);
  });
}

/* ================== RESULTS ================== */
function insightFromLowest(){
  const e=[['wb',state.wb],['kn',state.kn],['mo',state.mo],['so',state.so]].sort((a,b)=>a[1]-b[1])[0][0];
  return { wb:"Try small daily recovery habits: sunlight, journaling, movement, and hydration.",
           kn:"Structure beats panic ‚Äî spaced study with breaks improves retention.",
           mo:"Budget pressure compounds burnout; batch trips and explore RMIT financial advice.",
           so:"Even one weekly social contact protects wellbeing." }[e];
}
function achievements(){
  const arr=[];
  if(state.wb>=70 && state.kn>=60) arr.push("Balanced Success üéì");
  if(state.so>=70) arr.push("Social Butterfly ü¶ã");
  if(state.mo>=70) arr.push("Budget Boss üí∏");
  if(state.wb>=80) arr.push("Zen Master üßò");
  if(state.kn>=80) arr.push("Top Scorer üìö");
  return arr;
}
function endGame(){
  state.finished=true; show('results');
  const {wb,kn,mo,so}=state;
  let title='', body='';
  if (wb >= 70 && kn >= 60 && mo >= 35 && so >= 35){
    title="Balanced Success üéì";
    body=`${state.name||'You'} completed the semester sustainably. WB ${wb}, KN ${kn}, $ ${mo}, SO ${so}. ${state.journal? 'Reflection: '+state.journal:''}`;
    Confetti.burst();
  } else if (wb < 40){
    title="Burnout Warning üòµ";
    body=`High effort but low recovery (WB ${wb}). Consider counselling or a GP plan to protect sleep and pacing. ${state.journal? 'Reflection: '+state.journal:''}`;
  } else if (mo < 25){
    title="Financial Strain üí∏";
    body=`Money was a major stressor (MO ${mo}). Budgeting & campus services can protect wellbeing. ${state.journal? 'Reflection: '+state.journal:''}`;
  } else if (kn >= 70 && wb < 60){
    title="Grades at a Cost üìö";
    body=`Great marks (KN ${kn}) but wellbeing ${wb}. Sustainable strategies will help you thrive. ${state.journal? 'Reflection: '+state.journal:''}`;
  } else {
    title="Solid Pass ‚úÖ";
    body=`A decent balance overall. WB ${wb}, KN ${kn}, $ ${mo}, SO ${so}. ${state.journal? 'Reflection: '+state.journal:''}`;
  }
  document.getElementById('result-title').textContent=title; document.getElementById('result-body').textContent=body;
  document.getElementById('final-wb').textContent=wb; document.getElementById('final-kn').textContent=kn; document.getElementById('final-mo').textContent=mo; document.getElementById('final-so').textContent=so;
  drawRadar(wb,kn,mo,so); document.getElementById('insight').textContent = insightFromLowest();
  const badges = achievements(); document.getElementById('badge-list').textContent = badges.length? badges.join(' ‚Ä¢ ') : 'None ‚Äî try balancing next time';
  const avg = Math.round((wb+kn+mo+so)/4);
  const history = JSON.parse(localStorage.getItem(HISTORY_KEY)||'[]');
  const best = history.length? Math.max(...history.map(h=>h.avg)) : null;
  let msg = `This run average: <b>${avg}</b>`;
  if(best!==null){ const diff=avg-best; msg += ` ‚Ä¢ Previous best: <b>${best}</b> ‚Ä¢ ${diff>=0? 'Improved':'Down'} ${Math.abs(diff)} pts`; }
  else msg += ' ‚Ä¢ First recorded run üéâ';
  document.getElementById('leaderboard').innerHTML=msg;
  history.push({time:Date.now(), avg}); localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
  localStorage.removeItem(SAVE_KEY);
}

/* ================== SAVE / LOAD ================== */
function saveLocal(){ localStorage.setItem(SAVE_KEY, JSON.stringify(state)); }
function loadLocal(){ const raw=localStorage.getItem(SAVE_KEY); if(!raw) return false; try{ Object.assign(state, JSON.parse(raw)); return true; }catch{ return false; } }

/* ================== START / FLOW ================== */
function startNew(){
  state.name=document.getElementById('char-name').value||'Alex';
  state.major=document.getElementById('char-major').value;
  state.pronouns=document.getElementById('char-pronouns').value;
  mindfulMode = document.getElementById('toggle-mindful').checked;
  state.week=1; state.wb=70; state.kn=40; state.mo=50; state.so=40;
  state.finished=false; state.journal=''; state.feelings=''; state.log=[];
  state.eventHistory=[]; state.lastEventIdx=-1; state.deltaHistory=[];
  if (state.major==='Engineering'){ state.kn+=8; state.wb-=5; }
  if (state.major==='Health'){      state.wb+=8; state.mo-=6; }
  if (state.major==='Business'){    state.mo+=8; state.so+=4; }
  show('play'); updateHUD();
  renderEventByIndex(pickEventIndex());
  AudioSys.click(); setBackground(); saveLocal();
}
document.getElementById('btn-start').addEventListener('click', startNew);
document.getElementById('btn-continue').addEventListener('click', ()=>{
  if(loadLocal()){ mindfulMode = document.getElementById('toggle-mindful').checked; show('play'); updateHUD(); renderEventByIndex(pickEventIndex()); log(`Resumed save at Week ${state.week} for ${state.name}.`); AudioSys.click(); }
  else alert("No save found. Start a new semester.");
});
document.getElementById('btn-save').addEventListener('click', ()=>{ saveLocal(); log('<span class="pos">Progress saved.</span>'); AudioSys.click(); });
document.getElementById('btn-end').addEventListener('click', ()=>{ openJournal(); });

document.getElementById('btn-restart').addEventListener('click', ()=>show('menu'));
document.getElementById('btn-menu').addEventListener('click', ()=>show('menu'));
document.getElementById('btn-download').addEventListener('click', ()=>{
  const {name,major,pronouns,wb,kn,mo,so,feelings,journal}=state;
  const txt = `UniLife Simulator ‚Äî Journey Summary
Name: ${name}
Major: ${major} (${pronouns})
Final Stats: WB ${wb}, KN ${kn}, $ ${mo}, SO ${so}
Feelings: ${feelings||'-'}
Reflection: ${journal||'-'}

Recent Log:
(See in-game log)

Tips:
${insightFromLowest()}
`;
  const blob=new Blob([txt],{type:'text/plain'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=`unilife_summary_${Date.now()}.txt`; a.click(); URL.revokeObjectURL(url);
});

document.getElementById('btn-how').addEventListener('click', ()=>alert(
`Tips:
‚Ä¢ Balance matters: low wellbeing leads to poor outcomes even with high grades.
‚Ä¢ Use counselling and GP mental health plans early.
‚Ä¢ Plan study with breaks. Sleep and hydration are power-ups.
‚Ä¢ Money stress is real: batching trips and budgeting helps.
‚Ä¢ Social connection protects mental health.`
));
document.getElementById('toggle-ambience').addEventListener('change', e=>AudioSys.toggle(e.target.checked));
document.getElementById('vol').addEventListener('input', e=>AudioSys.setVolume(parseFloat(e.target.value)));

// Keyboard shortcuts
document.addEventListener('keydown', (e)=>{
  if(e.key==='Escape'){ document.querySelectorAll('.modal.show[data-esc]').forEach(m=>m.classList.remove('show')); }
  if(document.getElementById('view-play').style.display!=='block') return;
  const map={'1':0,'2':1,'3':2,'4':3};
  if(e.key in map){ const i=map[e.key]; const btns=Array.from(document.querySelectorAll('#ev-choices .btn')); btns[i]?.click(); }
  if(e.key.toLowerCase()==='s'){ document.getElementById('btn-save').click(); }
  if(e.key==='Enter'){ const first=document.querySelector('#ev-choices .btn'); first?.click(); }
});

/* ================== INIT ================== */
(function init(){
  AudioSys.setup();
  wbBar().style.width='70%'; knBar().style.width='40%'; moBar().style.width='50%'; soBar().style.width='40%';
  setBackground();
  const observer = new MutationObserver(()=>{ if(document.getElementById('view-play').style.display==='block'){ if(state.week===7 || state.week===14) openReflection(); } });
  observer.observe(document.getElementById('week-num'),{childList:true});
})();
</script>
</body>
</html>
