<!doctype html>
<html lang="en">
<head>
  <!--
    UniLife Simulator ‚Äî Peak Edition
    RMIT GenAI & Cybersecurity Hackathon 2025 ‚Ä¢ RMIT City ‚Ä¢ Team: The Trinity
    Front-end only ‚Ä¢ Single file ‚Ä¢ Offline ‚Ä¢ No external libs
  -->
  <meta charset="utf-8" />
  <title>UniLife Simulator ‚Äî RMIT City (Peak Edition)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* ===================== THEME ===================== */
    :root{
      --bg1:#eaf7f4; --bg2:#eaf2fb; --panel:#ffffff; --ink:#0a2a2e; --muted:#486e73;
      --accent:#2bb6f6; --accent2:#69e6b8; --stroke:#d8e5ec; --shadow:0 8px 26px rgba(9,30,66,.15);
      --good:#16a34a; --bad:#ef4444; --warn:#f59e0b;
      --barBG:#eef6fb; --barGrad:linear-gradient(90deg,#8ee3ff,#b9fbd6);
      --hue:0deg; /* dynamic lighting */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--ink);
      font-family:Inter,system-ui,Segoe UI,Arial,sans-serif;
      background:linear-gradient(180deg,var(--bg1),var(--bg2));
      filter:hue-rotate(var(--hue));
      transition:filter .8s ease;
    }
    .wrap{max-width:1120px;margin:0 auto;padding:20px;position:relative}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
    h1{margin:0;font-size:28px;line-height:1.1}
    .pill{font-size:12px;padding:4px 10px;border-radius:999px;border:1px solid var(--stroke);background:rgba(255,255,255,.9)}
    .card{background:var(--panel);border:1px solid var(--stroke);border-radius:16px;box-shadow:var(--shadow)}
    .panel{padding:18px}
    .row{display:flex;gap:16px;flex-wrap:wrap}
    .btn{border:1px solid var(--stroke);background:#f7fbff;color:var(--ink);padding:10px 14px;border-radius:12px;cursor:pointer}
    .btn:hover,.btn:focus{border-color:var(--accent);outline:none}
    .btn.primary{background:linear-gradient(135deg,#8ee3ff,#b9fbd6);color:#05292f;border:none}
    .btn.ghost{background:transparent}
    .muted{color:var(--muted)}
    footer{margin-top:12px;color:#5a7f85;font-size:12px;text-align:center}

    /* ===================== BACKGROUNDS (visual immersion) ===================== */
    .bg-stack{position:fixed;inset:0;z-index:-1}
    .bg {position:absolute;inset:0;opacity:0;transition:opacity 1.2s ease}
    .bg.show{opacity:0.9}
    /* simple gradients representing locations */
    .bg.library {background:radial-gradient(1200px 600px at 20% 10%, #fff 0%, #e8f2ff 40%, #dfe9ff 60%, #cfe0ff 100%)}
    .bg.tram    {background:linear-gradient(120deg,#e4fff4,#e0f4ff 60%, #d1e3ff)}
    .bg.dorm    {background:linear-gradient(180deg,#f7f0ff,#e8f6ff)}
    .bg.roof    {background:radial-gradient(800px 500px at 70% 20%,#fff 0%,#fff8ec 30%,#ffeed0 50%,#ffe3aa)}
    .bg.cafe    {background:linear-gradient(160deg,#fff4ea,#f0fff8)}

    /* ===================== HUD ===================== */
    .hud{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .stat{background:#f7fbff;border:1px solid var(--stroke);padding:10px 12px;border-radius:12px;display:flex;gap:10px;align-items:center}
    .bar{width:160px;height:10px;background:var(--barBG);border-radius:999px;overflow:hidden;border:1px solid var(--stroke)}
    .bar>span{display:block;height:100%;background:var(--barGrad);transition:width .25s ease}
    .week-pill{padding:6px 10px;border-radius:10px;border:1px solid var(--stroke);background:#fff}

    /* Legend/Objectives */
    .legend,.objective,.settings{
      background:#f7fbff;border:1px solid var(--stroke);border-radius:12px;padding:10px 12px;font-size:13px
    }
    .legend span{display:inline-block;margin-right:12px}
    .objective b{color:#0f5132}

    /* Event & Log */
    .log{height:260px;overflow:auto;background:#f7fbff;border:1px solid var(--stroke);border-radius:12px;padding:10px;font-size:14px;color:#335b60}
    .log p{margin:6px 0}
    .choices{display:grid;grid-template-columns:1fr;gap:10px}
    .choice-btn{display:flex;justify-content:space-between;align-items:center}
    .delta{font-size:12px;font-weight:600}
    .pos{color:var(--good)} .neg{color:var(--bad)}
    .tip{margin:10px 0 0}

    .two-col{display:grid;grid-template-columns:1.2fr .8fr;gap:16px}
    .play-grid{display:grid;grid-template-columns:1.3fr .7fr;gap:16px}
    @media (max-width:980px){
      .two-col,.play-grid{grid-template-columns:1fr}
    }

    /* Avatar */
    .avatar{font-size:36px;line-height:1;filter:drop-shadow(0 4px 10px rgba(0,0,0,.08))}
    .avatar-wrap{display:flex;align-items:center;gap:10px}

    /* Modal (reflections, feelings, trivia) */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:50}
    .modal.show{display:flex}
    .modal .box{max-width:640px;width:92%;background:#fff;border:1px solid var(--stroke);border-radius:16px;box-shadow:var(--shadow);padding:20px}
    .center{text-align:center}

    /* Study Buddy bubble */
    .buddy{position:fixed;right:16px;bottom:16px;background:#ffffffcc;border:1px solid var(--stroke);border-radius:14px;padding:10px 12px;font-size:13px;box-shadow:var(--shadow);display:none}
    .buddy.show{display:block;animation:floatUp 8s ease-in-out}
    @keyframes floatUp{0%{transform:translateY(0)}50%{transform:translateY(-6px)}100%{transform:translateY(0)}}

    /* Confetti & Radar */
    #confettiCanvas{position:fixed;inset:0;pointer-events:none;display:none;z-index:999}
    #radar{width:340px;height:340px;max-width:100%}

    /* Breathing circle */
    .breathe{width:120px;height:120px;border-radius:50%;margin:10px auto;background:radial-gradient(circle,#b9fbd6,#8ee3ff)}
    .breathe.pulse{animation:breath 6s ease-in-out infinite}
    @keyframes breath{0%{transform:scale(.9);opacity:.9}50%{transform:scale(1.04);opacity:1}100%{transform:scale(.9);opacity:.9}}
  </style>
</head>
<body>
  <!-- background stack -->
  <div class="bg-stack" aria-hidden="true">
    <div id="bgA" class="bg library show"></div>
    <div id="bgB" class="bg tram"></div>
  </div>
  <canvas id="confettiCanvas" aria-hidden="true"></canvas>

  <div class="wrap">
    <header>
      <h1>UniLife Simulator ‚Äî RMIT City</h1>
      <div><span class="pill">Peak Edition</span><span class="pill">Front-end only</span><span class="pill">Mental Health Focus</span></div>
    </header>

    <!-- MENU -->
    <main id="view-menu" class="card panel" role="region" aria-label="Menu">
      <div class="two-col">
        <section>
          <h2>Start your semester</h2>
          <p class="muted">Balance <b>Wellbeing</b>, <b>Knowledge</b>, <b>Money</b>, and <b>Social</b> across 15 weeks. Your aim is to succeed <em>without</em> burning out.</p>

          <div class="card panel" style="padding:14px">
            <label>Display Name<br/>
              <input id="char-name" placeholder="e.g., Alex" aria-label="Display Name" style="width:100%;padding:10px;border-radius:10px;border:1px solid var(--stroke);margin:6px 0 10px">
            </label>
            <label>Major<br/>
              <select id="char-major" aria-label="Major" style="width:100%;padding:10px;border-radius:10px;border:1px solid var(--stroke);margin:6px 0 10px">
                <option value="General">General Studies (balanced)</option>
                <option value="Engineering">Engineering (knowledge+, wellbeing-)</option>
                <option value="Health">Health Sciences (wellbeing+, money-)</option>
                <option value="Business">Business (money+, social+)</option>
              </select>
            </label>
            <label>Pronouns<br/>
              <select id="char-pronouns" aria-label="Pronouns" style="width:100%;padding:10px;border-radius:10px;border:1px solid var(--stroke);margin:6px 0 10px">
                <option value="they/them">they/them</option>
                <option value="she/her">she/her</option>
                <option value="he/him">he/him</option>
              </select>
            </label>
            <div class="row">
              <button class="btn primary" id="btn-start">Start Semester</button>
              <button class="btn" id="btn-continue">Continue Last Save</button>
            </div>
          </div>
        </section>

        <aside class="card panel">
          <h3 style="margin-top:0">How it works</h3>
          <ul class="muted">
            <li>Each turn = <b>1 week</b> (total 15)</li>
            <li>Each event offers <b>3‚Äì4 choices</b> with distinct impacts</li>
            <li>Stats: <b>WB</b>, <b>KN</b>, <b>$</b>, <b>SO</b></li>
            <li>Multiple endings based on balance, not just grades</li>
            <li><b>Keyboard:</b> 1‚Äì4 choose ‚Ä¢ <b>S</b> save ‚Ä¢ <b>Enter</b> first choice</li>
          </ul>
          <div class="settings" style="margin-top:10px">
            <label><input type="checkbox" id="toggle-ambience" checked> Ambient sound</label>
            <label style="margin-left:12px">Volume <input type="range" id="vol" min="0" max="1" step="0.02" value="0.3" style="vertical-align:middle"></label>
          </div>
        </aside>
      </div>
    </main>

    <!-- GAMEPLAY -->
    <section id="view-play" class="card panel" role="region" aria-label="Gameplay" style="display:none">
      <div class="play-grid">
        <div>
          <div class="hud" role="group" aria-label="HUD">
            <div class="week-pill" aria-live="polite">Week <span id="week-num">1</span>/15</div>
            <div class="stat" title="Wellbeing">WB <div class="bar"><span id="wb-bar"></span></div><span id="wb-num" aria-label="Wellbeing">70</span></div>
            <div class="stat" title="Knowledge">KN <div class="bar"><span id="kn-bar"></span></div><span id="kn-num" aria-label="Knowledge">40</span></div>
            <div class="stat" title="Money">$ <div class="bar"><span id="mo-bar"></span></div><span id="mo-num" aria-label="Money">50</span></div>
            <div class="stat" title="Social">SO <div class="bar"><span id="so-bar"></span></div><span id="so-num" aria-label="Social">40</span></div>
            <div class="avatar-wrap"><span class="muted">Mood:</span> <span id="avatar" class="avatar" aria-label="Avatar">üôÇ</span></div>
            <button class="btn" id="btn-save" aria-label="Save progress">üíæ Save</button>
            <button class="btn ghost" id="btn-end" aria-label="End early">End Early</button>
          </div>

          <div class="legend" style="margin-top:10px"><b>Legend:</b>
            <span title="Wellbeing">WB = Wellbeing</span>
            <span title="Knowledge">KN = Knowledge</span>
            <span title="Money">$ = Money</span>
            <span title="Social">SO = Social</span>
          </div>

          <div id="event-card" class="card panel" style="background:#f7fbff;margin-top:12px">
            <h3 id="ev-title" style="margin:0 0 6px">Welcome to Week 1</h3>
            <p id="ev-text" class="muted" style="margin-top:0">Make a choice to set your rhythm.</p>
            <div class="choices" id="ev-choices" role="group" aria-label="Choices"></div>
            <p id="ev-tip" class="muted tip" aria-live="polite"></p>
          </div>

          <div class="objective" style="margin-top:12px" aria-label="Objective">
            üéØ <b>Objective:</b> Maintain balance. Aim for <b>Wellbeing ‚â• 60</b> by Week 15 while building Knowledge to pass.
          </div>
        </div>

        <aside class="card panel" aria-label="Action Log">
          <h3 style="margin-top:0">Log</h3>
          <div id="log" class="log" aria-live="polite"></div>
          <div class="legend" style="margin-top:10px"><b>Trivia</b>: <span id="trivia">‚Äî</span></div>
        </aside>
      </div>
    </section>

    <!-- RESULTS -->
    <section id="view-results" class="card panel" role="region" aria-label="Results" style="display:none">
      <h2 id="result-title" style="margin-top:0">Semester Summary</h2>
      <p id="result-body" class="muted"></p>

      <div class="row" style="align-items:center">
        <canvas id="radar" width="360" height="360" aria-label="Stats radar chart"></canvas>
        <div class="card panel" style="background:#f7fbff;flex:1 1 320px">
          <h3 style="margin:0 0 6px">Personal Insights</h3>
          <p id="insight" class="muted">‚Äî</p>
          <div id="achievements" class="legend" style="margin-top:10px"><b>Achievements:</b> <span id="badge-list">None yet</span></div>

          <h3 style="margin:12px 0 6px">Helpful resources (Australia)</h3>
          <ul style="margin:0 0 6px 18px">
            <li><a href="https://www.lifeline.org.au/" target="_blank" rel="noopener">Lifeline ‚Äî 13 11 14</a></li>
            <li><a href="https://www.beyondblue.org.au/" target="_blank" rel="noopener">Beyond Blue ‚Äî 1300 22 4636</a></li>
            <li><a href="https://www.rmit.edu.au/students/support-and-facilities/student-support/counselling" target="_blank" rel="noopener">RMIT Counselling & Wellbeing</a></li>
          </ul>
          <p class="muted" style="margin:6px 0 0">If it‚Äôs an emergency, call <b>000</b>.</p>
        </div>
      </div>

      <div class="legend" style="margin-top:10px">
        <b>Final Stats:</b>
        <span id="final-wb"></span> WB ‚Ä¢ <span id="final-kn"></span> KN ‚Ä¢ <span id="final-mo"></span> $ ‚Ä¢ <span id="final-so"></span> SO
      </div>

      <div class="row" style="align-items:center;margin-top:10px">
        <button class="btn" id="btn-download">üìÑ Download Journey</button>
        <div class="legend" id="leaderboard" style="flex:1 1 auto">‚Äî</div>
      </div>

      <div class="center" style="margin-top:10px">
        <div class="breathe pulse" aria-hidden="true"></div>
      </div>

      <div class="hud" style="margin-top:10px">
        <button class="btn primary" id="btn-restart">Play Again</button>
        <button class="btn ghost" id="btn-menu">Back to Menu</button>
      </div>
    </section>

    <footer>¬© 2025 The Trinity ‚Äî RMIT City Campus ‚Ä¢ Front-end only</footer>
  </div>

  <!-- Modals -->
  <div id="modal-reflect" class="modal" role="dialog" aria-modal="true" aria-labelledby="reflect-title">
    <div class="box">
      <h3 id="reflect-title">Mid-Semester Check-In</h3>
      <p id="reflect-body" class="muted"></p>
      <div class="center"><button class="btn primary" id="reflect-continue">Continue</button></div>
    </div>
  </div>

  <div id="modal-feel" class="modal" role="dialog" aria-modal="true" aria-labelledby="feel-title">
    <div class="box">
      <h3 id="feel-title">The semester is ending. How do you feel right now?</h3>
      <div class="row" style="justify-content:center">
        <button class="btn" data-feel="Hopeful">Hopeful üå§Ô∏è</button>
        <button class="btn" data-feel="Exhausted">Exhausted üòÆ‚Äçüí®</button>
        <button class="btn" data-feel="Proud">Proud üéâ</button>
        <button class="btn" data-feel="Worried">Worried üòü</button>
      </div>
    </div>
  </div>

  <div id="modal-journal" class="modal" role="dialog" aria-modal="true" aria-labelledby="journal-title">
    <div class="box">
      <h3 id="journal-title">Final Reflection</h3>
      <p class="muted">Choose one sentence that best summarises your term‚Äôs lesson:</p>
      <div class="row" style="justify-content:center">
        <button class="btn" data-j="Small daily recovery beats last-minute rescue.">Small daily recovery beats last-minute rescue.</button>
        <button class="btn" data-j="Balance isn‚Äôt perfection ‚Äî it‚Äôs pacing and support.">Balance isn‚Äôt perfection ‚Äî it‚Äôs pacing and support.</button>
        <button class="btn" data-j="Connection fuels learning more than isolation.">Connection fuels learning more than isolation.</button>
        <button class="btn" data-j="Boundaries at work protect my study and sleep.">Boundaries at work protect my study and sleep.</button>
      </div>
    </div>
  </div>

  <div id="modal-trivia" class="modal" role="dialog" aria-modal="true" aria-labelledby="trivia-title">
    <div class="box">
      <h3 id="trivia-title">Did you know?</h3>
      <p id="trivia-body" class="muted"></p>
      <div class="center"><button class="btn" id="trivia-ok">Got it</button></div>
    </div>
  </div>

  <!-- Study Buddy bubble -->
  <div id="buddy" class="buddy" aria-live="polite">Stay hydrated before you decide üíß</div>

  <script>
    /* ===================== UTIL & STATE ===================== */
    const $ = sel => document.querySelector(sel);
    const rnd = arr => arr[(Math.random()*arr.length)|0];
    const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));

    const MAX_WEEKS=15, SAVE_KEY='unilife_save', HISTORY_KEY='unilife_history';
    const state = {
      name:'Alex', major:'General', pronouns:'they/them',
      week:1, wb:70, kn:40, mo:50, so:40,
      finished:false, journal:'', feelings:'', log:[]
    };

    /* ===================== BACKGROUNDS & LIGHTING ===================== */
    const BG_CLASSES = ['library','tram','dorm','roof','cafe'];
    let bgToggle=false;
    function setBackground(){
      const next = rnd(BG_CLASSES);
      const A = $('#bgA'), B = $('#bgB');
      if(!bgToggle){ A.className = 'bg '+next+' show'; B.className='bg '+rnd(BG_CLASSES); }
      else { B.className='bg '+next+' show'; A.className='bg '+rnd(BG_CLASSES); }
      bgToggle=!bgToggle;
      document.documentElement.style.setProperty('--hue', (state.week*8)+'deg');
    }

    /* ===================== AUDIO ===================== */
    const AudioSys = (()=>{
      const ctx = window.AudioContext? new AudioContext(): null;
      let master = null, volNode = null;
      let breezeOsc=null, rainNoise=null, birdsOsc=null;
      let ambienceOn = true;

      function setup(){
        if(!ctx) return;
        master = ctx.createGain(); volNode = ctx.createGain();
        master.connect(volNode).connect(ctx.destination);
        master.gain.value = 1; volNode.gain.value = $('#vol').value;
      }
      function setVolume(v){ if(volNode) volNode.gain.value=v; }
      function toggle(on){ ambienceOn = on; if(!on) stopAll(); else updateAmbience(); }
      function click(){ beep({freq:600, dur:0.08, type:'sine', vol:0.04}); }
      function good(){ beep({freq:740, dur:0.12, type:'triangle', vol:0.04}); }
      function bad(){ beep({freq:300, dur:0.16, type:'sawtooth', vol:0.035}); }
      function beep({freq=440,dur=0.1,type='sine',vol=0.03}){
        if(!ctx) return;
        const o=ctx.createOscillator(), g=ctx.createGain();
        o.type=type; o.frequency.value=freq; g.gain.value=vol;
        o.connect(g).connect(ctx.destination); o.start();
        g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + dur);
        o.stop(ctx.currentTime + dur + 0.02);
      }

      // Ambient synths (lightweight):
      function startBreeze(){
        if(!ctx) return;
        if(breezeOsc) return;
        breezeOsc = ctx.createOscillator();
        const g = ctx.createGain(); g.gain.value = 0.02;
        breezeOsc.type='sine'; breezeOsc.frequency.value=180;
        breezeOsc.connect(g).connect(master); breezeOsc.start();
      }
      function startRain(){
        if(!ctx) return;
        if(rainNoise) return;
        const buffer = ctx.createBuffer(1, ctx.sampleRate*2, ctx.sampleRate);
        const data = buffer.getChannelData(0);
        for (let i=0;i<data.length;i++){ data[i] = (Math.random()*2-1) * 0.3; } // white noise
        rainNoise = ctx.createBufferSource(); rainNoise.buffer=buffer; rainNoise.loop=true;
        const g = ctx.createGain(); g.gain.value = 0.04;
        rainNoise.connect(g).connect(master); rainNoise.start();
      }
      function startBirds(){
        if(!ctx) return;
        if(birdsOsc) return;
        birdsOsc = ctx.createOscillator();
        const g = ctx.createGain(); g.gain.value = 0.015;
        birdsOsc.type='triangle'; birdsOsc.frequency.value=880;
        birdsOsc.connect(g).connect(master); birdsOsc.start();
      }
      function stopAll(){
        if(breezeOsc){ breezeOsc.stop(); breezeOsc.disconnect(); breezeOsc=null; }
        if(rainNoise){ try{rainNoise.stop()}catch{}; rainNoise.disconnect(); rainNoise=null; }
        if(birdsOsc){ birdsOsc.stop(); birdsOsc.disconnect(); birdsOsc=null; }
      }
      function updateAmbience(){
        if(!ctx || !ambienceOn) return;
        stopAll();
        // mood-based: high WB -> breeze + birds; low WB -> rain
        if(state.wb >= 70){ startBreeze(); startBirds(); }
        else if(state.wb < 40){ startRain(); }
        else { startBreeze(); }
      }
      return {setup,setVolume,toggle,click,good,bad,updateAmbience};
    })();

    /* ===================== CONFETTI ===================== */
    const Confetti = (()=>{
      const cvs = $('#confettiCanvas'), x = cvs.getContext('2d');
      let parts=[], running=false, raf=null;
      function resize(){ cvs.width=innerWidth; cvs.height=innerHeight; }
      addEventListener('resize', resize); resize();
      function burst(n=160){
        parts=[];
        for(let i=0;i<n;i++){
          parts.push({
            x: innerWidth/2, y: innerHeight/3,
            vx:(Math.random()-0.5)*6, vy:(Math.random()-0.8)*6 - 2,
            g:0.12+Math.random()*0.1, s:4+Math.random()*4, a:1,
            c:`hsl(${Math.random()*360},80%,70%)`, rot:Math.random()*6.28, vr:(Math.random()-0.5)*0.2
          });
        }
        cvs.style.display='block'; running=true; loop();
        setTimeout(()=>{running=false; cvs.style.display='none';}, 2600);
      }
      function loop(){
        if(!running){ cancelAnimationFrame(raf); return; }
        raf=requestAnimationFrame(loop);
        x.clearRect(0,0,cvs.width,cvs.height);
        parts.forEach(p=>{
          p.vy+=p.g; p.x+=p.vx; p.y+=p.vy; p.rot+=p.vr; p.a*=0.996;
          x.save(); x.globalAlpha=p.a; x.translate(p.x,p.y); x.rotate(p.rot);
          x.fillStyle=p.c; x.fillRect(-p.s/2,-p.s/2,p.s,p.s); x.restore();
        });
      }
      return {burst};
    })();

    /* ===================== EVENTS (‚â•15) ===================== */
    const EVENTS = [
      { title:"Week start routine", text:"How do you set your rhythm this week?",
        options:[
          {label:"Plan Pomodoro + breaks", delta:{wb:+4, kn:+4, mo:0, so:+1}, tip:"Intervals support focus & recovery."},
          {label:"Grind long sessions",   delta:{wb:-6, kn:+6, mo:0, so:-1}, tip:"Overwork harms sleep & mood."},
          {label:"Light start + coffee with a mate", delta:{wb:+3, kn:+1, mo:-2, so:+4}, tip:"Connection boosts motivation."}
        ]},
      { title:"Heatwave alert", text:"It‚Äôs 36‚Äì38¬∞C with high UV in Melbourne.",
        options:[
          {label:"Study early indoors + hydrate", delta:{wb:+4, kn:+2, mo:0, so:0}, tip:"Heat & dehydration impair cognition."},
          {label:"Outdoor cram", delta:{wb:-6, kn:+2, mo:0, so:0}, tip:"High heat worsens fatigue."},
          {label:"Short gym session", delta:{wb:+3, kn:+1, mo:-1, so:+1}, tip:"Light exercise stabilises mood."}
        ]},
      { title:"Group assignment", text:"Team proposes splitting tasks and milestones.",
        options:[
          {label:"Define roles & deadlines", delta:{wb:+3, kn:+5, mo:0, so:+2}, tip:"Clarity lowers stress."},
          {label:"Let it evolve organically", delta:{wb:-4, kn:+1, mo:0, so:-1}, tip:"Chaos ‚Üí crunch later."},
          {label:"Volunteer for heavy part", delta:{wb:-3, kn:+6, mo:0, so:+1}, tip:"Growth, but mind the load."}
        ]},
      { title:"Part-time shift offer", text:"Manager asks for an extra evening shift.",
        options:[
          {label:"Negotiate different slot", delta:{wb:+2, kn:+2, mo:+2, so:0}, tip:"Boundaries protect sleep & study."},
          {label:"Accept & cut sleep", delta:{wb:-7, kn:+2, mo:+5, so:0}, tip:"Sleep loss tanks mood."},
          {label:"Decline this week", delta:{wb:+1, kn:+1, mo:0, so:-1}, tip:"Short-term no, long-term wellbeing."}
        ]},
      { title:"Counselling drop-in", text:"Free short consults available this week.",
        options:[
          {label:"Attend 20-min session", delta:{wb:+8, kn:0, mo:0, so:+1}, tip:"Early support prevents escalation."},
          {label:"Read self-help page", delta:{wb:+3, kn:+1, mo:0, so:0}, tip:"Psychoeducation helps too."},
          {label:"Skip ‚Äî no time", delta:{wb:-3, kn:+1, mo:0, so:0}, tip:"Avoidance often backfires."}
        ]},
      { title:"Myki fares & budget", text:"Transport costs are tight this month.",
        options:[
          {label:"Batch on-campus days", delta:{wb:+2, kn:+2, mo:+3, so:0}, tip:"Fewer trips = lower stress & cost."},
          {label:"Travel daily as usual", delta:{wb:0, kn:+1, mo:-3, so:+1}, tip:"Routine ok, but costs add up."},
          {label:"Study from home", delta:{wb:+1, kn:+1, mo:+2, so:-2}, tip:"Remote helps, less social."}
        ]},
      { title:"Exam prep", text:"Two finals are approaching.",
        options:[
          {label:"Timetable + breaks", delta:{wb:+3, kn:+6, mo:0, so:0}, tip:"Structure beats panic."},
          {label:"All-nighter blitz", delta:{wb:-10,kn:+6, mo:0, so:-1}, tip:"Crash risk next week."},
          {label:"Peer study circle", delta:{wb:+3, kn:+5, mo:0, so:+3}, tip:"Belonging lifts motivation."}
        ]},
      { title:"Sleep hygiene", text:"It‚Äôs late. Caffeine is tempting.",
        options:[
          {label:"Wind-down + water", delta:{wb:+4, kn:+1, mo:0, so:0}, tip:"Sleep quality compounds."},
          {label:"Late coffee & scroll", delta:{wb:-5, kn:0, mo:0, so:-1}, tip:"Stimulants disrupt sleep."},
          {label:"Tea + journaling", delta:{wb:+3, kn:+1, mo:0, so:0}, tip:"Reflection regulates stress."}
        ]},
      { title:"Inclusion event", text:"Cultural society invites you to an evening gathering.",
        options:[
          {label:"Attend & connect", delta:{wb:+4, kn:+1, mo:-2, so:+5}, tip:"Belonging protects mental health."},
          {label:"Drop by briefly", delta:{wb:+2, kn:+1, mo:-1, so:+2}, tip:"Micro-social boosts morale."},
          {label:"Skip to study", delta:{wb:-1, kn:+3, mo:0, so:-2}, tip:"Over-isolation risks burnout."}
        ]},
      { title:"Rent pressure", text:"Your rent increases mid-semester.",
        options:[
          {label:"Budget & seek advice", delta:{wb:+1, kn:+1, mo:+4, so:0}, tip:"Student services can help."},
          {label:"Cut social for savings", delta:{wb:-2, kn:+1, mo:+5, so:-4}, tip:"Balance cost & connection."},
          {label:"Ignore for now", delta:{wb:-5, kn:0, mo:-3, so:0}, tip:"Uncertainty magnifies stress."}
        ]},
      { title:"Digital overload", text:"Screen time hit 5+ hours/day.",
        options:[
          {label:"App timers + focus mode", delta:{wb:+3, kn:+2, mo:0, so:0}, tip:"Boundaries restore attention."},
          {label:"No change", delta:{wb:-3, kn:0, mo:0, so:0}, tip:"Doomscroll drains mood."},
          {label:"Reading group", delta:{wb:+2, kn:+3, mo:0, so:+2}, tip:"Analog focus + community."}
        ]},
      { title:"Library workshop", text:"Referencing & research workshop on campus.",
        options:[
          {label:"Attend session", delta:{wb:+1, kn:+5, mo:0, so:+1}, tip:"Skills reduce future stress."},
          {label:"Browse slides later", delta:{wb:+1, kn:+2, mo:0, so:0}, tip:"Better than skipping."},
          {label:"Skip", delta:{wb:0, kn:0, mo:0, so:0}, tip:"Missed opportunity."}
        ]},
      { title:"Healthy snack", text:"You‚Äôve got 20 minutes between lectures.",
        options:[
          {label:"Fruit + water", delta:{wb:+2, kn:+1, mo:-1, so:0}, tip:"Steady energy > sugar spikes."},
          {label:"Energy drink", delta:{wb:-1, kn:+1, mo:-2, so:0}, tip:"Crash likely later."},
          {label:"Walk with a mate", delta:{wb:+2, kn:+1, mo:0, so:+3}, tip:"Movement + connection help mood."}
        ]},
      { title:"Commute delay", text:"Signal fault on the line, you‚Äôre stuck.",
        options:[
          {label:"Plan tasks & revise", delta:{wb:+1, kn:+2, mo:0, so:0}, tip:"Reframe dead time."},
          {label:"Mindfulness break", delta:{wb:+2, kn:+1, mo:0, so:0}, tip:"Brief resets aid focus."},
          {label:"Panic & scroll", delta:{wb:-3, kn:0, mo:0, so:0}, tip:"Anxiety drains energy."}
        ]},
      { title:"Peer check-in", text:"A friend asks how you‚Äôre coping.",
        options:[
          {label:"Open up & plan week", delta:{wb:+5, kn:+1, mo:0, so:+3}, tip:"Social support is protective."},
          {label:"Short chat", delta:{wb:+2, kn:+1, mo:0, so:+2}, tip:"Even brief contact helps."},
          {label:"Ghost them", delta:{wb:-3, kn:0, mo:0, so:-3}, tip:"Isolation raises risk."}
        ]},
      { title:"Clinic visit", text:"GP bookings for Mental Health Plans (Medicare rebates).",
        options:[
          {label:"Book GP this week", delta:{wb:+9, kn:0, mo:-1, so:+1}, tip:"Early care, lower cost."},
          {label:"Read about options", delta:{wb:+3, kn:+1, mo:0, so:0}, tip:"Inform first ‚Äî then act."},
          {label:"Delay another month", delta:{wb:-2, kn:0, mo:0, so:0}, tip:"Delays add stress."}
        ]}
    ];

    /* ===================== TRIVIA ===================== */
    const TRIVIA = [
      "7‚Äì9 hours of sleep improves memory consolidation.",
      "Brief daylight exposure supports circadian rhythm and mood.",
      "Social connection is a protective factor for student mental health.",
      "Hydration can improve attention and reduce fatigue.",
      "Short movement breaks help sustain focus during study.",
      "Early support (counselling/GP plan) reduces escalation risk.",
      "Planning study with breaks beats cramming for long-term retention."
    ];

    /* ===================== RENDER HELPERS ===================== */
    const wbBar = () => $('#wb-bar'), knBar=()=>$('#kn-bar'), moBar=()=>$('#mo-bar'), soBar=()=>$('#so-bar');
    const logEl = $('#log');
    function fmt(v){ return (v>=0?'+':'') + v; }
    function color(v){ return `<span class="${v>=0?'pos':'neg'}">${fmt(v)}</span>`; }
    function updateHUD(){
      $('#week-num').textContent = state.week;
      $('#wb-num').textContent = clamp(state.wb,0,100);
      $('#kn-num').textContent = clamp(state.kn,0,100);
      $('#mo-num').textContent = clamp(state.mo,0,100);
      $('#so-num').textContent = clamp(state.so,0,100);
      wbBar().style.width = clamp(state.wb,0,100) + '%';
      knBar().style.width = clamp(state.kn,0,100) + '%';
      moBar().style.width = clamp(state.mo,0,100) + '%';
      soBar().style.width = clamp(state.so,0,100) + '%';
      // Avatar mood
      const a=$('#avatar');
      a.textContent = state.wb>=70?'üòÑ': state.wb>=40?'üôÇ': state.wb>=20?'üòì':'ü•µ';
      // Atmosphere & ambience
      document.body.style.filter = `hue-rotate(${state.wb>=70?0: state.wb<40?20:10}deg)`;
      AudioSys.updateAmbience();
    }
    function show(view){
      $('#view-menu').style.display   = view==='menu'?'block':'none';
      $('#view-play').style.display   = view==='play'?'block':'none';
      $('#view-results').style.display= view==='results'?'block':'none';
    }
    function log(html){ const p=document.createElement('p'); p.innerHTML=html; logEl.prepend(p); state.log.push(strip(html)); if(state.log.length>120) state.log.shift(); }
    function strip(html){ const d=document.createElement('div'); d.innerHTML=html; return d.textContent||d.innerText||''; }

    /* ===================== EVENT FLOW ===================== */
    function renderEvent(ev){
      $('#ev-title').textContent=ev.title; $('#ev-text').textContent=ev.text;
      const box=$('#ev-choices'); box.innerHTML='';
      ev.options.forEach((opt,i)=>{
        const b=document.createElement('button');
        b.className='btn choice-btn';
        b.setAttribute('aria-label',`Choice ${i+1}: ${opt.label}`);
        b.innerHTML=`<span>${String.fromCharCode(65+i)}) ${opt.label}</span>
                     <span class="delta">WB ${color(opt.delta.wb||0)} ‚Ä¢ KN ${color(opt.delta.kn||0)} ‚Ä¢ $ ${color(opt.delta.mo||0)} ‚Ä¢ SO ${color(opt.delta.so||0)}</span>`;
        b.addEventListener('click',()=>applyChoice(opt));
        box.appendChild(b);
      });
      $('#ev-tip').textContent='';
      // Show weekly trivia (non-blocking)
      $('#trivia').textContent = rnd(TRIVIA);
      // Rotate backgrounds weekly
      setBackground();
    }

    function applyChoice(opt){
      state.wb = clamp(state.wb + (opt.delta.wb||0), 0, 100);
      state.kn = clamp(state.kn + (opt.delta.kn||0), 0, 100);
      state.mo = clamp(state.mo + (opt.delta.mo||0), 0, 100);
      state.so = clamp(state.so + (opt.delta.so||0), 0, 100);
      updateHUD();
      log(`${opt.label} ‚Üí WB ${color(opt.delta.wb||0)} ‚Ä¢ KN ${color(opt.delta.kn||0)} ‚Ä¢ $ ${color(opt.delta.mo||0)} ‚Ä¢ SO ${color(opt.delta.so||0)}`);
      $('#ev-tip').textContent='Tip: '+(opt.tip||'');
      const sum=(opt.delta.wb||0)+(opt.delta.kn||0)+(opt.delta.mo||0)+(opt.delta.so||0);
      if(sum>=0) AudioSys.good(); else AudioSys.bad();

      // Check reflections (Week 7 & 14)
      if(state.week===7 || state.week===14){
        openReflection();
        return; // reflection will advance week after close
      }

      // Pre-final feelings at week 15 start
      if(state.week===14){ /* next advance goes to 15 -> feelings modal in advanceWeek */ }

      advanceWeekOrEnd();
      saveLocal();
    }

    function advanceWeekOrEnd(){
      if(state.week >= MAX_WEEKS){ openJournal(); return; }
      state.week += 1;
      updateHUD();
      renderEvent(rnd(EVENTS));
      saveLocal();
    }

    /* ===================== MODALS: Reflection & Feelings & Journal ===================== */
    function openReflection(){
      const modal = $('#modal-reflect');
      const strong = strongestStat(); const weak = weakestStat();
      const lines = {
        wb:"You‚Äôve cared for your energy even when deadlines loomed.",
        kn:"You‚Äôve pushed your learning steadily ‚Äî nice pacing.",
        mo:"You‚Äôve kept a careful eye on costs under pressure.",
        so:"You‚Äôve made time for people who lift you up."
      };
      const concerns = {
        wb:"But rest has been thin ‚Äî small daily resets could help.",
        kn:"But learning felt frantic at times ‚Äî structure beats panic.",
        mo:"Money stress is heavy ‚Äî batching trips or budgeting may ease it.",
        so:"Connection dipped ‚Äî even one weekly catch-up protects wellbeing."
      };
      $('#reflect-title').textContent = state.week===7? "Mid-Semester Check-In":"Second Wind Check-In";
      $('#reflect-body').textContent = `So far, your strength is ${labelOf(strong)}. ${lines[strong]} Your lowest area is ${labelOf(weak)}. ${concerns[weak]}`;
      modal.classList.add('show');
      $('#reflect-continue').onclick = ()=>{
        modal.classList.remove('show');
        advanceWeekOrEnd();
      };
    }

    function openFeelings(){
      const modal=$('#modal-feel'); modal.classList.add('show');
      modal.querySelectorAll('button[data-feel]').forEach(btn=>{
        btn.onclick=()=>{
          const val=btn.getAttribute('data-feel'); state.feelings=val;
          // small stat nudge
          if(val==='Hopeful'){ state.wb=clamp(state.wb+2,0,100); }
          if(val==='Exhausted'){ state.wb=clamp(state.wb-2,0,100); }
          if(val==='Proud'){ state.so=clamp(state.so+2,0,100); }
          if(val==='Worried'){ state.kn=clamp(state.kn+1,0,100); state.wb=clamp(state.wb-1,0,100); }
          updateHUD();
          modal.classList.remove('show');
          advanceWeekOrEnd();
        };
      });
    }

    function openJournal(){
      const modal=$('#modal-journal'); modal.classList.add('show');
      modal.querySelectorAll('button[data-j]').forEach(btn=>{
        btn.onclick=()=>{
          state.journal=btn.getAttribute('data-j');
          modal.classList.remove('show');
          endGame();
        };
      });
    }

    /* ===================== STUDY BUDDY PROMPTS ===================== */
    const BUDDY = [
      "Drink water before you decide üíß",
      "Short stretch = better focus üßò",
      "Text a mate ‚Äî connection helps ‚òï",
      "Write a tiny plan then act ‚úçÔ∏è",
      "Breathe in‚Ä¶ out‚Ä¶ you‚Äôve got this üåø"
    ];
    function showBuddy(){
      const el=$('#buddy'); el.textContent = rnd(BUDDY);
      el.classList.add('show'); setTimeout(()=>el.classList.remove('show'), 4000);
    }
    setInterval(()=>{ if($('#view-play').style.display==='block' && Math.random()<0.25) showBuddy(); }, 10000);

    /* ===================== RESULTS & RADAR ===================== */
    function drawRadar(wb,kn,mo,so){
      const c = $('#radar'), x=c.getContext('2d');
      const W=c.width,H=c.height,cx=W/2,cy=H/2,r=Math.min(W,H)/2-30;
      x.clearRect(0,0,W,H);
      x.strokeStyle='#dbe7ee'; x.lineWidth=1;
      for(let i=1;i<=3;i++){ x.beginPath(); x.arc(cx,cy,(r*i)/3,0,Math.PI*2); x.stroke(); }
      const labels=['Wellbeing','Knowledge','Money','Social'];
      x.fillStyle='#486e73'; x.font='12px system-ui';
      for(let i=0;i<4;i++){
        const a=(-Math.PI/2)+(i*Math.PI/2);
        const ex=cx+Math.cos(a)*r, ey=cy+Math.sin(a)*r;
        x.beginPath(); x.moveTo(cx,cy); x.lineTo(ex,ey); x.stroke();
        const lx=cx+Math.cos(a)*(r+12), ly=cy+Math.sin(a)*(r+12);
        x.textAlign='center'; x.textBaseline='middle'; x.fillText(labels[i],lx,ly);
      }
      const vals=[wb,kn,mo,so].map(v=>clamp(v,0,100));
      x.beginPath();
      for(let i=0;i<4;i++){
        const a=(-Math.PI/2)+(i*Math.PI/2), pr=r*(vals[i]/100);
        const px=cx+Math.cos(a)*pr, py=cy+Math.sin(a)*pr;
        i?x.lineTo(px,py):x.moveTo(px,py);
      }
      x.closePath();
      const grad=x.createLinearGradient(0,0,W,H); grad.addColorStop(0,'#8ee3ff88'); grad.addColorStop(1,'#b9fbd688');
      x.fillStyle=grad; x.fill(); x.strokeStyle='#2bb6f6'; x.lineWidth=2; x.stroke();
    }

    function insightFromLowest(){
      const lowK = weakestStat();
      const map = {
        wb:"Try small daily recovery habits: sunlight, journaling, movement, and hydration.",
        kn:"Structure beats panic ‚Äî spaced study with short breaks improves retention.",
        mo:"Budget pressure compounds burnout; batch trips and explore RMIT financial advice.",
        so:"Even one weekly social contact protects wellbeing. A short coffee counts."
      };
      return map[lowK];
    }

    function achievements(){
      const arr=[];
      if(state.wb>=70 && state.kn>=60) arr.push("Balanced Success üéì");
      if(state.so>=70) arr.push("Social Butterfly ü¶ã");
      if(state.mo>=70) arr.push("Budget Boss üí∏");
      if(state.wb>=80) arr.push("Zen Master üßò");
      if(state.kn>=80) arr.push("Top Scorer üìö");
      return arr;
    }

    function endGame(){
      state.finished=true; show('results');
      const {wb,kn,mo,so}=state;
      let title='', body='';
      if (wb >= 70 && kn >= 60 && mo >= 35 && so >= 35){
        title="Balanced Success üéì";
        body=`${state.name||'You'} completed the semester with sustainable habits. Wellbeing ${wb}, Knowledge ${kn}, Money ${mo}, Social ${so}. ${state.journal? 'Reflection: '+state.journal:''}`;
        Confetti.burst();
      } else if (wb < 40){
        title="Burnout Warning üòµ";
        body=`High effort but low recovery (WB ${wb}). Consider counselling or a GP plan; protect sleep and pacing. ${state.journal? 'Reflection: '+state.journal:''}`;
      } else if (mo < 25){
        title="Financial Strain üí∏";
        body=`Money was a major stressor (MO ${mo}). Budgeting & campus services can protect wellbeing. ${state.journal? 'Reflection: '+state.journal:''}`;
      } else if (kn >= 70 && wb < 60){
        title="Grades at a Cost üìö";
        body=`Great marks (KN ${kn}) but wellbeing ${wb}. Sustainable strategies will help you thrive. ${state.journal? 'Reflection: '+state.journal:''}`;
      } else {
        title="Solid Pass ‚úÖ";
        body=`A decent balance overall. WB ${wb}, KN ${kn}, $ ${mo}, SO ${so}. ${state.journal? 'Reflection: '+state.journal:''}`;
      }
      $('#result-title').textContent=title; $('#result-body').textContent=body;
      $('#final-wb').textContent=wb; $('#final-kn').textContent=kn; $('#final-mo').textContent=mo; $('#final-so').textContent=so;
      drawRadar(wb,kn,mo,so);
      $('#insight').textContent = insightFromLowest();

      const badges = achievements();
      $('#badge-list').textContent = badges.length? badges.join(' ‚Ä¢ ') : 'None ‚Äî try balancing next time';

      // Local leaderboard (compare to previous best average)
      const avg = Math.round((wb+kn+mo+so)/4);
      const history = JSON.parse(localStorage.getItem(HISTORY_KEY)||'[]');
      const best = history.length? Math.max(...history.map(h=>h.avg)) : null;
      let msg = `This run average: <b>${avg}</b>`;
      if(best!==null){
        const diff = avg - best;
        msg += ` ‚Ä¢ Previous best: <b>${best}</b> ‚Ä¢ ${diff>=0? 'Improved':'Down'} ${Math.abs(diff)} pts`;
      } else msg += ' ‚Ä¢ First recorded run üéâ';
      $('#leaderboard').innerHTML = msg;

      history.push({time:Date.now(), avg}); localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
      localStorage.removeItem(SAVE_KEY); // fresh replays
    }

    /* ===================== STATS HELPERS ===================== */
    function labelOf(k){ return ({wb:"Wellbeing",kn:"Knowledge",mo:"Money",so:"Social"})[k]; }
    function strongestStat(){
      const entries=[['wb',state.wb],['kn',state.kn],['mo',state.mo],['so',state.so]];
      return entries.sort((a,b)=>b[1]-a[1])[0][0];
    }
    function weakestStat(){
      const entries=[['wb',state.wb],['kn',state.kn],['mo',state.mo],['so',state.so]];
      return entries.sort((a,b)=>a[1]-b[1])[0][0];
    }

    /* ===================== SAVE / LOAD ===================== */
    function saveLocal(){ localStorage.setItem(SAVE_KEY, JSON.stringify(state)); }
    function loadLocal(){
      const raw=localStorage.getItem(SAVE_KEY); if(!raw) return false;
      try{ Object.assign(state, JSON.parse(raw)); return true; } catch{ return false; }
    }

    /* ===================== VIEW CONTROL ===================== */
    function startNew(){
      state.name = $('#char-name').value || 'Alex';
      state.major = $('#char-major').value;
      state.pronouns = $('#char-pronouns').value;
      state.week=1; state.wb=70; state.kn=40; state.mo=50; state.so=40;
      state.finished=false; state.journal=''; state.feelings=''; state.log=[];
      if (state.major==='Engineering'){ state.kn += 8; state.wb -= 5; }
      if (state.major==='Health'){      state.wb += 8; state.mo -= 6; }
      if (state.major==='Business'){    state.mo += 8; state.so += 4; }
      show('play'); updateHUD(); renderEvent(rnd(EVENTS));
      log(`New semester started for <b>${state.name}</b> (${state.pronouns}), Major: ${state.major}.`);
      AudioSys.click(); setBackground(); saveLocal();
    }

    /* ===================== BUTTONS ===================== */
    $('#btn-start').addEventListener('click', ()=>{ startNew(); });
    $('#btn-continue').addEventListener('click', ()=>{
      if(loadLocal()){ show('play'); updateHUD(); renderEvent(rnd(EVENTS)); log(`Resumed save at Week ${state.week} for ${state.name}.`); AudioSys.click(); }
      else alert("No save found. Start a new semester.");
    });
    $('#btn-save').addEventListener('click', ()=>{ saveLocal(); log('<span class="pos">Progress saved.</span>'); AudioSys.click(); });
    $('#btn-end').addEventListener('click', ()=>{ openJournal(); });

    $('#btn-restart').addEventListener('click', ()=>{ show('menu'); });
    $('#btn-menu').addEventListener('click', ()=>{ show('menu'); });

    $('#btn-download').addEventListener('click', ()=>{
      const {name,major,pronouns,wb,kn,mo,so,feelings,journal}=state;
      const txt = `UniLife Simulator ‚Äî Journey Summary
Name: ${name}
Major: ${major} (${pronouns})
Final Stats: WB ${wb}, KN ${kn}, $ ${mo}, SO ${so}
Feelings: ${feelings||'-'}
Reflection: ${journal||'-'}

Recent Log:
- ${state.log.slice(-20).reverse().join('\n- ')}

Tips:
${insightFromLowest()}
`;
      const blob = new Blob([txt], {type:'text/plain'});
      const url = URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download=`unilife_summary_${Date.now()}.txt`; a.click();
      URL.revokeObjectURL(url);
    });

    $('#btn-how').addEventListener('click', ()=>alert(
`Tips:
‚Ä¢ Balance matters: low wellbeing leads to poor outcomes even with high grades.
‚Ä¢ Use counselling and GP mental health plans early.
‚Ä¢ Plan study with breaks. Sleep and hydration are power-ups.
‚Ä¢ Money stress is real: batching trips and budgeting helps.
‚Ä¢ Social connection protects mental health.`
    ));

    // Settings
    $('#toggle-ambience').addEventListener('change', e=>AudioSys.toggle(e.target.checked));
    $('#vol').addEventListener('input', e=>AudioSys.setVolume(parseFloat(e.target.value)));

    // Keyboard: 1‚Äì4 choose, S save, Enter = first option
    document.addEventListener('keydown', (e)=>{
      if($('#view-play').style.display!=='block') return;
      const keys={'1':0,'2':1,'3':2,'4':3};
      if(e.key in keys){
        const idx=keys[e.key];
        const btns = Array.from(document.querySelectorAll('#ev-choices .btn'));
        btns[idx]?.click();
      }
      if(e.key.toLowerCase()==='s'){ $('#btn-save').click(); }
      if(e.key==='Enter'){
        const first = document.querySelector('#ev-choices .btn'); first?.click();
      }
    });

    /* ===================== WEEKLY ADVANCE HOOK (feelings) ===================== */
    // Intercept going from week 14 -> 15 to ask feelings
    const _advance = advanceWeekOrEnd;
    advanceWeekOrEnd = function(){
      if(state.week===14){ openFeelings(); return; }
      _advance();
    }

    /* ===================== INIT ===================== */
    (function init(){
      // Prepare audio graph
      AudioSys.setup();
      // Seed bars
      wbBar().style.width='70%'; knBar().style.width='40%'; moBar().style.width='50%'; soBar().style.width='40%';
      // Trivia popup (optional blocking modal once in a while)
      setInterval(()=>{
        if($('#view-play').style.display==='block' && Math.random()<0.12){
          $('#trivia-body').textContent = rnd(TRIVIA);
          $('#modal-trivia').classList.add('show');
          $('#trivia-ok').onclick = ()=>$('#modal-trivia').classList.remove('show');
        }
      }, 12000);
      // Initial background
      setBackground();
    })();
  </script>
</body>
</html>
